- name: Deploy backend safely from GitHub
  hosts: backend
  become: true

  vars:
    app_user: roboshop
    tmp_clone_dir: /tmp/contact-manager-repo      # TMP folder for entire repo
    tmp_backend_dir: /tmp/backend_temp           # TMP folder for backend only
    app_dir: /app/backend
    repo_url: "https://github.com/AlankarSingh27/Contact-Manager.git"
    repo_branch: "main"
    jwt_secret_key: "{{ lookup('env', 'JWT_SECRET_KEY') }}"
    mongo_cloud_url: "{{ lookup('env', 'MONGO_DB_CLOUD_URL') }}"
    mongo_database: "{{ lookup('env', 'MONGO_DB_DATABASE') }}"

  tasks:

    # 1ï¸âƒ£ Ensure app user exists
    - name: Check if app user exists
      command: id {{ app_user }}
      register: out
      ignore_errors: true

    - name: Create app user if not exists
      user:
        name: "{{ app_user }}"
        shell: /bin/bash
      when: out.rc != 0

    # 2ï¸âƒ£ Clone GitHub repo into TMP
    - name: Clone entire repo into TMP
      git:
        repo: "{{ repo_url }}"
        dest: "{{ tmp_clone_dir }}"
        version: "{{ repo_branch }}"
        force: yes
      become_user: "{{ app_user }}"

    # 3ï¸âƒ£ Ensure TMP backend staging folder exists
    - name: Ensure temporary backend folder exists
      file:
        path: "{{ tmp_backend_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'

    # 4ï¸âƒ£ Copy backend subfolder from repo TMP to backend TMP folder
    - name: Copy backend folder from repo to temp backend folder
      command: >
        rsync -a --delete {{ tmp_clone_dir }}/backend/ {{ tmp_backend_dir }}/
      become_user: "{{ app_user }}"

    # 5ï¸âƒ£ Ensure final app directory exists
    - name: Ensure backend app directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: '0755'

    # 6ï¸âƒ£ Copy backend code from TMP backend to final app directory
    - name: Copy backend code from TMP backend to app folder
      command: >
        rsync -a --delete {{ tmp_backend_dir }}/ {{ app_dir }}/
      become_user: "{{ app_user }}"

    # 7ï¸âƒ£ Create .env file in backend folder
    - name: Create backend .env file
      template:
        src: env.j2
        dest: "{{ app_dir }}/.env"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0600"

    # 8ï¸âƒ£ Install npm dependencies
    - name: Install backend npm dependencies
      command: npm install
      args:
        chdir: "{{ app_dir }}"
      become_user: "{{ app_user }}"

    # 9ï¸âƒ£ Build TypeScript if needed
    - name: Build TypeScript
      command: npx tsc
      args:
        chdir: "{{ app_dir }}"
      ignore_errors: yes
      become_user: "{{ app_user }}"

    # ğŸ”Ÿ Start backend using PM2
    - name: Start backend using PM2
      command: >
        pm2 restart backend ||
        pm2 start dist/index.js --name backend ||
        pm2 start index.js --name backend
      args:
        chdir: "{{ app_dir }}"
      become_user: "{{ app_user }}"
