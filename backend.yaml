- name: Deploy Local Backend Code Safely
  hosts: backend
  become: true

  vars:
    app_user: roboshop
    local_backend_path: "/home/ec2-user/Contact-Manager/backend"
    app_dir: /app

    jwt_secret_key: "{{ lookup('env', 'JWT_SECRET_KEY') }}"
    mongo_cloud_url: "{{ lookup('env', 'MONGO_DB_CLOUD_URL') }}"
    mongo_database: "{{ lookup('env', 'MONGO_DB_DATABASE') }}"

  tasks:

    - name: Ensure roboshop user exists
      user:
        name: "{{ app_user }}"
        shell: /bin/bash
        create_home: yes

    - name: Add NodeSource repo for Node.js 18
      shell: curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
      args:
        warn: false

    - name: Install Node.js and npm
      package:
        name: nodejs
        state: present

    - name: Install PM2 globally
      npm:
        name: pm2
        global: yes
        state: present

    # ğŸŸ¢ Yeh task ensure karta hai ki /app directory exist kare
    - name: Ensure /app directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0755"

    - name: Copy backend from local path to /app
      command: rsync -a --delete {{ local_backend_path }}/ {{ app_dir }}/
      become_user: "{{ app_user }}"

    - name: Create backend .env file
      template:
        src: env.j2
        dest: "{{ app_dir }}/.env"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: "0600"

    - name: Install backend npm dependencies
      npm:
        path: "{{ app_dir }}"
        production: false
      become_user: "{{ app_user }}"

    - name: Build TypeScript
      command: npx tsc
      args:
        chdir: "{{ app_dir }}"
      become_user: "{{ app_user }}"

    - name: Start or restart backend using PM2
      shell: |
        pm2 describe backend > /dev/null 2>&1
        if [ $? -eq 0 ]; then
            pm2 restart backend --update-env
        else
            pm2 start dist/index.js --name backend
        fi
        pm2 save
      args:
        chdir: "{{ app_dir }}"
      become_user: "{{ app_user }}"

