- name: Deploy backend from local folder
  hosts: backend
  become: true

  vars:
    app_user: roboshop
    app_dir: /app
    local_backend_path: /home/ec2-user/Contact-Manager/backend

  tasks:

    # 1ï¸âƒ£ Ensure roboshop user exists
    - name: Ensure roboshop user exists
      user:
        name: "{{ app_user }}"
        shell: /bin/bash
        create_home: yes

    # 2ï¸âƒ£ Add NodeSource repo for Node.js 18
    - name: Add NodeSource repo for Node.js 18
      shell: curl -fsSL https://rpm.nodesource.com/setup_18.x | bash -
    
    # 3ï¸âƒ£ Install Node.js and npm
    - name: Install Node.js and npm
      package:
        name: nodejs
        state: present

    # 4ï¸âƒ£ Install PM2 globally
    - name: Install PM2 globally
      npm:
        name: pm2
        global: yes
        state: present

    # 5ï¸âƒ£ Ensure /app directory exists
    - name: Ensure /app directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        mode: '0755'

    # 6ï¸âƒ£ Set ownership of /app directory
    - name: Set ownership of /app directory
      file:
        path: "{{ app_dir }}"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        recurse: yes

    # 7ï¸âƒ£ Copy backend code to server
    - name: Copy backend code to server
      copy:
        src: "{{ local_backend_path }}/"
        dest: "{{ app_dir }}/"
        owner: "{{ app_user }}"
        group: "{{ app_user }}"
        mode: 0755
      become: true

    # 8ï¸âƒ£ Install npm dependencies
    - name: Install npm dependencies
      command: npm install
      args:
        chdir: "{{ app_dir }}"
      become_user: "{{ app_user }}"

    # 9ï¸âƒ£ Ensure TypeScript is installed locally
    - name: Ensure TypeScript is installed locally
      npm:
        name: typescript
        path: "{{ app_dir }}"
        state: present
      become_user: "{{ app_user }}"

    # ğŸ”Ÿ Build TypeScript to generate server.js
    - name: Build TypeScript
      command: npx tsc
      args:
        chdir: "{{ app_dir }}"
      become_user: "{{ app_user }}"

    # 1ï¸âƒ£1ï¸âƒ£ Check if compiled server.js exists
    - name: Check if server.js exists
      stat:
        path: "{{ app_dir }}/server.js"
      register: server_js_file

    # 1ï¸âƒ£2ï¸âƒ£ Start or restart backend using PM2
    - name: Start or restart backend using PM2
      shell: |
        pm2 describe backend > /dev/null 2>&1
        if [ $? -eq 0 ]; then
            pm2 restart backend --update-env
        else
            pm2 start server.js --name backend
        fi
      args:
        chdir: "{{ app_dir }}"
      become_user: "{{ app_user }}"
      when: server_js_file.stat.exists

